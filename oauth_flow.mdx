---
title: "OAuthèªè¨¼ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ•ãƒ­ãƒ¼"
description: "OAuthã§èªè¨¼ã‚’è¡Œã†ã¾ã§ã®ã‚µãƒ³ãƒ—ãƒ«ã§ã™"
---
<Warning>
å®Ÿéš›ã®æœ¬ç•ªç’°å¢ƒã§ã¯ã€é©åˆ‡ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚
</Warning>

## ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œé †åº

OAuthèªè¨¼ãƒ•ãƒ­ãƒ¼ã‚’æ­£ã—ãå®Ÿè¡Œã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®é †åºã§é€²ã‚ã¦ãã ã•ã„ï¼š

<Steps>
  <Step title="èªè¨¼é–‹å§‹">
    Consoleã‹ã‚‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
  </Step>
  <Step title="èªè¨¼é–‹å§‹">
    èªå¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’èªè¨¼ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
  </Step>
  <Step title="èªå¯ã‚³ãƒ¼ãƒ‰å–å¾—">
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªè¨¼ã‚’å®Œäº†ã™ã‚‹ã¨ã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯URLã§èªå¯ã‚³ãƒ¼ãƒ‰ã‚’å—ä¿¡
  </Step>
  <Step title="ãƒˆãƒ¼ã‚¯ãƒ³äº¤æ›">
    ãƒˆãƒ¼ã‚¯ãƒ³ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§èªå¯ã‚³ãƒ¼ãƒ‰ã‚’ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã«äº¤æ›
  </Step>
  <Step title="ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—">
    ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
  </Step>
  <Step title="ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†">
    å¿…è¦ã«å¿œã˜ã¦ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ã€æ›´æ–°ã€å¤±åŠ¹
  </Step>
</Steps>

---

## ã‚¹ãƒ†ãƒƒãƒ— 1: OAuthã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ä½œæˆ

1. **ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹**
   
   [https://account.playtune.jp/v1/dashboard/client/new](https://account.playtune.jp/v1/dashboard/client/new) ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™

2. **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å…¥åŠ›**
   - **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å**: ã‚ãªãŸã®ã‚¢ãƒ—ãƒªå
   - **ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURI**: `https://yourapp.com/callback`
   - **è¨±å¯ã‚¹ã‚³ãƒ¼ãƒ—**: é€šå¸¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã¯`openid` `user.profile.basic` `user.profile.contact`ã‚’é¸æŠã—ã¾ã™

3. **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæƒ…å ±ã‚’å–å¾—**
   ä½œæˆå®Œäº†å¾Œã€ä»¥ä¸‹ã®æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼š
   ```
   Client ID: abc123xyz789
   Client Secret: secret_key_here
   ```

## ã‚¹ãƒ†ãƒƒãƒ—ï¼’: èªå¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

OAuth ãƒ•ãƒ­ãƒ¼ã®æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’èªè¨¼ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã“ã¨ã§ã™ã€‚

### GET /oauth/authorize

<CodeGroup>

```bash GET /oauth/authorize
curl "https://account.playtune.jp/v1/api/oauth/authorize?response_type=code&client_id=client_PnLkTZ6PUCF9PsuV&redirect_uri=https%3A%2F%2Faccount.playtune.jp%2Fv1%2Fcallback&scope=openid%20user.profile.basic%20user.profile.contact&state=test_state_123&code_challenge=E9Melhoa2OwvFrEMTJguCHaoeK1t8URWbuGJSstw-cM&code_challenge_method=S256" \
  -H "Accept: application/json" \
  -H "User-Agent: curl/7.68.0"
```

```javascript JavaScript
const authUrl = new URL('https://account.playtune.jp/v1/api/oauth/authorize');
authUrl.searchParams.set('response_type', 'code');
authUrl.searchParams.set('client_id', 'client_PnLkTZ6PUCF9PsuV');
authUrl.searchParams.set('redirect_uri', 'https://account.playtune.jp/v1/callback');
authUrl.searchParams.set('scope', 'openid user.profile.basic user.profile.contact');
authUrl.searchParams.set('state', 'test_state_123');
authUrl.searchParams.set('code_challenge', 'E9Melhoa2OwvFrEMTJguCHaoeK1t8URWbuGJSstw-cM');
authUrl.searchParams.set('code_challenge_method', 'S256');

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’èªè¨¼ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
window.location.href = authUrl.toString();
```

```python Python
import urllib.parse

params = {
    'response_type': 'code',
    'client_id': 'client_PnLkTZ6PUCF9PsuV',
    'redirect_uri': 'https://account.playtune.jp/v1/callback',
    'scope': 'openid user.profile.basic user.profile.contact',
    'state': 'test_state_123',
    'code_challenge': 'E9Melhoa2OwvFrEMTJguCHaoeK1t8URWbuGJSstw-cM',
    'code_challenge_method': 'S256'
}

auth_url = f"https://account.playtune.jp/v1/api/oauth/authorize?{urllib.parse.urlencode(params)}"
print(f"èªå¯URL: {auth_url}")
```

```php PHP
<?php
$params = [
    'response_type' => 'code',
    'client_id' => 'client_12345',
    'redirect_uri' => 'https://account.playtune.jp/v1/callback',
    'scope' => 'openid user.profile.basic user.profile.contact',
    'state' => 'test_state_123',
    'code_challenge' => 'E9Melhoa2OwvFrEMTJguCHaoeK1t8URWbuGJSstw-cM',
    'code_challenge_method' => 'S256'
];

$auth_url = 'https://account.playtune.jp/v1/api/oauth/authorize?' . http_build_query($params);

// ãƒ–ãƒ©ã‚¦ã‚¶ã‚¢ã‚¯ã‚»ã‚¹ã®å ´åˆã¯ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
header("Location: " . $auth_url);
exit();
?>
```

```go Go
package main

import (
    "fmt"
    "net/url"
)

func main() {
    baseURL := "https://account.playtune.jp/v1/api/oauth/authorize"
    
    params := url.Values{}
    params.Set("response_type", "code")
    params.Set("client_id", "client_12345")
    params.Set("redirect_uri", "https://account.playtune.jp/v1/callback")
    params.Set("scope", "openid user.profile.basic user.profile.contact")
    params.Set("state", "test_state_123")
    params.Set("code_challenge", "E9Melhoa2OwvFrEMTJguCHaoeK1t8URWbuGJSstw-cM")
    params.Set("code_challenge_method", "S256")
    
    authURL := fmt.Sprintf("%s?%s", baseURL, params.Encode())
    fmt.Printf("èªå¯URL: %s\n", authURL)
}
```

```dart Dart
import 'dart:convert';

void main() {
  final baseUrl = Uri.parse('https://account.playtune.jp/v1/api/oauth/authorize');
  
  final authUrl = baseUrl.replace(queryParameters: {
    'response_type': 'code',
    'client_id': 'client_12345',
    'redirect_uri': 'https://account.playtune.jp/v1/callback',
    'scope': 'openid user.profile.basic user.profile.contact',
    'state': 'test_state_123',
    'code_challenge': 'E9Melhoa2OwvFrEMTJguCHaoeK1t8URWbuGJSstw-cM',
    'code_challenge_method': 'S256',
  });
  
  print('èªå¯URL: $authUrl');
}
```

</CodeGroup>

### ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | å¿…é ˆ | èª¬æ˜ | å€¤ã®ä¾‹ |
|---|---|---|---|
| `response_type` | âœ“ | ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ— | `code` |
| `client_id` | âœ“ | ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID | `client_PnLkTZ6PUCF9PsuV` |
| `redirect_uri` | âœ“ | ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURI | `https://account.playtune.jp/v1/callback` |
| `scope` | âœ“ | ã‚¹ã‚³ãƒ¼ãƒ—ï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šï¼‰ | `openid user.profile.basic user.profile.contact` |
| `state` | æ¨å¥¨ | CSRFé˜²æ­¢ç”¨ãƒ©ãƒ³ãƒ€ãƒ æ–‡å­—åˆ— | `test_state_123` |
| `code_challenge` | æ¨å¥¨* | PKCEãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼ˆBase64URLï¼‰ | `E9Melhoa2OwvFrEMTJguCHaoeK1t8URWbuGJSstw-cM` |
| `code_challenge_method` | æ¨å¥¨* | PKCEãƒ¡ã‚½ãƒƒãƒ‰ | `S256` |
| `nonce` | ã‚ªãƒ—ã‚·ãƒ§ãƒ³ | OpenID Connectç”¨ãƒ©ãƒ³ãƒ€ãƒ æ–‡å­—åˆ— | `abc123` |

<Info>
***æ¨å¥¨***: æœ¬ç•ªç’°å¢ƒã§ã¯ `code_challenge` ã¨ `code_challenge_method` ãŒå¿…é ˆã§ã™ã€‚é–‹ç™ºç’°å¢ƒã§ã¯çœç•¥å¯èƒ½ã§ã™ã€‚
</Info>

### åˆ©ç”¨å¯èƒ½ãªã‚¹ã‚³ãƒ¼ãƒ—

| ã‚¹ã‚³ãƒ¼ãƒ— | èª¬æ˜ |
|---------|-----|
| `openid` | OpenID ConnectåŸºæœ¬èªè¨¼ï¼ˆå¿…é ˆï¼‰ |
| `user.profile.basic` | åŸºæœ¬ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ± |
| `user.profile.contact` | é€£çµ¡å…ˆæƒ…å ±ï¼ˆãƒ¡ãƒ¼ãƒ«ç­‰ï¼‰ |
| `user.profile.role` | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ãƒ¼ãƒ«æƒ…å ± |
| `user.profile.extended` | æ‹¡å¼µãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ± |
| `user.social.accounts` | ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ± |
| `user.commerce.orders` | æ³¨æ–‡å±¥æ­´ï¼ˆèª­ã¿å–ã‚Šï¼‰ |
| `user.commerce.subscriptions` | ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æƒ…å ± |
| `user.commerce.orders.write` | æ³¨æ–‡æƒ…å ±ï¼ˆæ›¸ãè¾¼ã¿ï¼‰ |
| `user.preferences.favorites` | ãŠæ°—ã«å…¥ã‚Šãƒ»è¨­å®šæƒ…å ± |

<Warning>
å¾“æ¥ã® `profile` ã‚„ `email` ã‚¹ã‚³ãƒ¼ãƒ—ã¯å»ƒæ­¢ã•ã‚Œã¾ã—ãŸã€‚æ–°ã—ã„ã‚¹ã‚³ãƒ¼ãƒ—ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
</Warning>

### ãƒ¬ã‚¹ãƒãƒ³ã‚¹

#### CLI/APIã‚¢ã‚¯ã‚»ã‚¹æ™‚ï¼ˆUser-Agent: curl, postmanç­‰ï¼‰

```json
{
  "message": "Browser-based authorization required",
  "authorization_url": "https://account.playtune.jp/v1/api/oauth/authorize?response_type=code&client_id=client_12345&redirect_uri=https%3A//account.playtune.jp/v1/callback&scope=openid+user.profile.basic+user.profile.contact&state=test_state_123&code_challenge=E9Melhoa2OwvFrEMTJguCHaoeK1t8URWbuGJSstw-cM&code_challenge_method=S256",
  "instructions": [
    "1. Open the authorization URL in your browser",
    "2. Complete the authentication process",
    "3. The authorization code will be sent to your registered redirect URI"
  ],
  "client_name": "Test Application",
  "note": "This endpoint requires user interaction and cannot be completed via CLI/API calls alone"
}
```

#### ãƒ–ãƒ©ã‚¦ã‚¶ã‚¢ã‚¯ã‚»ã‚¹æ™‚

**ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆï¼ˆ307 Temporary Redirectï¼‰:**
```
Location: https://account.playtune.jp/v1/api/oauth/authorize?response_type=code&client_id=...
```

#### èªè¨¼å®Œäº†å¾Œã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯

èªè¨¼ãŒæˆåŠŸã™ã‚‹ã¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æŒ‡å®šã—ãŸ `redirect_uri` ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã¾ã™ï¼š

**æˆåŠŸæ™‚:**
```
https://account.playtune.jp/v1/callback?code=SplxlOBeZQQYbYS6WxSbIA&state=test_state_123
```

**ã‚¨ãƒ©ãƒ¼æ™‚:**
```
https://account.playtune.jp/v1/callback?error=access_denied&error_description=The%20user%20denied%20the%20request&state=test_state_123
```

#### ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹

**ç„¡åŠ¹ãªã‚¹ã‚³ãƒ¼ãƒ—:**
```json
{
  "error": "invalid_scope",
  "error_description": "Invalid scopes: profile, email. Allowed scopes: openid, user.profile.basic, user.profile.contact, user.profile.role, user.profile.extended, user.social.accounts, user.commerce.orders, user.commerce.subscriptions, user.commerce.orders.write, user.preferences.favorites",
  "error_uri": "https://tools.ietf.org/html/rfc6749#section-4.1.2.1"
}
```

**å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸è¶³:**
```json
{
  "error": "invalid_request",
  "error_description": "Missing required parameters: scope",
  "missing_parameters": ["scope"],
  "provided_parameters": ["response_type", "client_id", "redirect_uri"],
  "error_uri": "https://tools.ietf.org/html/rfc6749#section-4.1.2.1"
}
```

---

## ã‚¹ãƒ†ãƒƒãƒ—3: ãƒˆãƒ¼ã‚¯ãƒ³ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

èªå¯ã‚³ãƒ¼ãƒ‰ã‚’ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¨äº¤æ›ã—ã¾ã™ã€‚ã“ã‚ŒãŒOAuthãƒ•ãƒ­ãƒ¼ã®æ ¸å¿ƒéƒ¨åˆ†ã§ã™ã€‚

### POST /oauth/token

<CodeGroup>

```bash POST /oauth/token
curl -X POST 'https://account.playtune.jp/v1/api/oauth/token' \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -H 'Authorization: Basic ZGVtb19jbGllbnRfMTIzNDU6ZGVtb19zZWNyZXRfYWJjZGVm' \
  -d 'grant_type=authorization_code' \
  -d 'code=YOUR_AUTHORIZATION_CODE' \
  -d 'redirect_uri=https://playground.playtune.jp/callback' \
  -d 'code_verifier=dBjftJeZ4CVP-mB92K27uhbUJU1p1r_wW1gFWFOEjXk'
```

```javascript JavaScript
const response = await fetch('https://account.playtune.jp/v1/api/oauth/token', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/x-www-form-urlencoded',
    'Authorization': 'Basic ' + btoa('demo_client_12345:demo_secret_abcdef')
  },
  body: new URLSearchParams({
    grant_type: 'authorization_code',
    code: 'YOUR_AUTHORIZATION_CODE',
    redirect_uri: 'https://playground.playtune.jp/callback',
    code_verifier: 'dBjftJeZ4CVP-mB92K27uhbUJU1p1r_wW1gFWFOEjXk'
  })
});

const tokens = await response.json();
console.log('ãƒˆãƒ¼ã‚¯ãƒ³:', tokens);
```

```python Python
import requests
import base64

headers = {
    'Content-Type': 'application/x-www-form-urlencoded',
    'Authorization': 'Basic ' + base64.b64encode(b'demo_client_12345:demo_secret_abcdef').decode()
}

data = {
    'grant_type': 'authorization_code',
    'code': 'YOUR_AUTHORIZATION_CODE',
    'redirect_uri': 'https://playground.playtune.jp/callback',
    'code_verifier': 'dBjftJeZ4CVP-mB92K27uhbUJU1p1r_wW1gFWFOEjXk'
}

response = requests.post(
    'https://account.playtune.jp/v1/api/oauth/token',
    headers=headers,
    data=data
)

tokens = response.json()
print('ãƒˆãƒ¼ã‚¯ãƒ³:', tokens)
```

</CodeGroup>

### ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | å¿…é ˆ | èª¬æ˜ | å€¤ã®ä¾‹ |
|---|---|---|---|
| `grant_type` | âœ“ | ã‚°ãƒ©ãƒ³ãƒˆã‚¿ã‚¤ãƒ— | `authorization_code` |
| `code` | âœ“ | èªå¯ã‚³ãƒ¼ãƒ‰ | Step 1ã§å–å¾—ã—ãŸã‚³ãƒ¼ãƒ‰ |
| `redirect_uri` | âœ“ | ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURI | `https://playground.playtune.jp/callback` |
| `code_verifier` | âœ“ | PKCEæ¤œè¨¼ã‚³ãƒ¼ãƒ‰ | `dBjftJeZ4CVP-mB92K27uhbUJU1p1r_wW1gFWFOEjXk` |

### ãƒ¬ã‚¹ãƒãƒ³ã‚¹

**æˆåŠŸæ™‚:**
```json
{
  "access_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "Bearer",
  "expires_in": 300,
  "refresh_token": "rt.a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6",
  "scope": "openid profile email",
  "id_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

**ã‚¨ãƒ©ãƒ¼æ™‚:**
```json
{
  "error": "invalid_grant",
  "error_description": "The provided authorization grant is invalid."
}
```

---

## ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—

å–å¾—ã—ãŸã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã—ã¾ã™ã€‚

### GET /oauth/userinfo

<CodeGroup>

```bash GET /oauth/userinfo
curl -X GET 'https://account.playtune.jp/v1/api/oauth/userinfo' \
  -H 'Authorization: Bearer YOUR_ACCESS_TOKEN'
```

```javascript JavaScript
const response = await fetch('https://account.playtune.jp/v1/api/oauth/userinfo', {
  headers: {
    'Authorization': 'Bearer YOUR_ACCESS_TOKEN'
  }
});

const userInfo = await response.json();
console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±:', userInfo);
```

```python Python
import requests

headers = {
    'Authorization': 'Bearer YOUR_ACCESS_TOKEN'
}

response = requests.get(
    'https://account.playtune.jp/v1/api/oauth/userinfo',
    headers=headers
)

user_info = response.json()
print('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±:', user_info)
```

</CodeGroup>
### ãƒ¬ã‚¹ãƒãƒ³ã‚¹

**æˆåŠŸæ™‚:**
```json
{
  "sub": "user123456789",
  "email": "tanaka@example.com",
  "email_verified": true,
  "name": "ç”°ä¸­å¤ªéƒ",
  "preferred_username": "tanaka"
}
```

### ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | èª¬æ˜ | å¿…è¦ã‚¹ã‚³ãƒ¼ãƒ— |
|---|---|---|---|
| `sub` | string | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸€æ„è­˜åˆ¥å­ | `openid` |
| `email` | string | ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ | `email` |
| `email_verified` | boolean | ãƒ¡ãƒ¼ãƒ«èªè¨¼æ¸ˆã¿ã‹ã©ã†ã‹ | `email` |
| `name` | string | è¡¨ç¤ºå | `profile` |
| `preferred_username` | string | æ¨å¥¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å | `profile` |

---

## ã‚¹ãƒ†ãƒƒãƒ—5: è¿½åŠ ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

### ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ (Introspection)

<CodeGroup>

```bash POST /oauth/introspect
curl -X POST 'https://account.playtune.jp/v1/api/oauth/introspect' \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -H 'Authorization: Basic ZGVtb19jbGllbnRfMTIzNDU6ZGVtb19zZWNyZXRfYWJjZGVm' \
  -d 'token=YOUR_ACCESS_TOKEN' \
  -d 'token_type_hint=access_token'
```

```javascript JavaScript
const response = await fetch('https://account.playtune.jp/v1/api/oauth/introspect', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/x-www-form-urlencoded',
    'Authorization': 'Basic ' + btoa('demo_client_12345:demo_secret_abcdef')
  },
  body: new URLSearchParams({
    token: 'YOUR_ACCESS_TOKEN',
    token_type_hint: 'access_token'
  })
});

const introspection = await response.json();
console.log('ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼çµæœ:', introspection);
```

</CodeGroup>

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹ï¼ˆæœ‰åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³ï¼‰:**
```json
{
  "active": true,
  "client_id": "demo_client_12345",
  "scope": "openid profile email",
  "sub": "user123456789",
  "exp": 1728123456,
  "iat": 1728120456,
  "token_type": "access_token"
}
```

### ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³

<CodeGroup>

```bash POST /oauth/token (refresh)
curl -X POST 'https://account.playtune.jp/v1/api/oauth/token' \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -H 'Authorization: Basic ZGVtb19jbGllbnRfMTIzNDU6ZGVtb19zZWNyZXRfYWJjZGVm' \
  -d 'grant_type=refresh_token' \
  -d 'refresh_token=YOUR_REFRESH_TOKEN'
```

```javascript JavaScript
const response = await fetch('https://account.playtune.jp/v1/api/oauth/token', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/x-www-form-urlencoded',
    'Authorization': 'Basic ' + btoa('demo_client_12345:demo_secret_abcdef')
  },
  body: new URLSearchParams({
    grant_type: 'refresh_token',
    refresh_token: 'YOUR_REFRESH_TOKEN'
  })
});

const newTokens = await response.json();
console.log('æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³:', newTokens);
```

</CodeGroup>

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**
```json
{
  "access_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "Bearer",
  "expires_in": 300,
  "refresh_token": "rt.k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6"
}
```

### ãƒˆãƒ¼ã‚¯ãƒ³å¤±åŠ¹

<CodeGroup>

```bash POST /oauth/revoke
curl -X POST 'https://account.playtune.jp/v1/api/oauth/revoke' \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -H 'Authorization: Basic ZGVtb19jbGllbnRfMTIzNDU6ZGVtb19zZWNyZXRfYWJjZGVm' \
  -d 'token=YOUR_REFRESH_TOKEN' \
  -d 'token_type_hint=refresh_token'
```

```javascript JavaScript
const response = await fetch('https://account.playtune.jp/v1/api/oauth/revoke', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/x-www-form-urlencoded',
    'Authorization': 'Basic ' + btoa('demo_client_12345:demo_secret_abcdef')
  },
  body: new URLSearchParams({
    token: 'YOUR_REFRESH_TOKEN',
    token_type_hint: 'refresh_token'
  })
});

// æˆåŠŸæ™‚ã¯200 OKãŒè¿”ã•ã‚Œã‚‹ï¼ˆãƒœãƒ‡ã‚£ãªã—ï¼‰
```

</CodeGroup>


## PKCEå®Ÿè£…ã‚¬ã‚¤ãƒ‰

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã®ãŸã‚ã€PKCEãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’å¼·ãæ¨å¥¨ã—ã¾ã™ã€‚

### PKCEç”Ÿæˆã‚³ãƒ¼ãƒ‰

<Accordion title="PKCEå®Ÿè£…ä¾‹">

```javascript JavaScript
// Code Verifierç”Ÿæˆ
function generateCodeVerifier() {
  const array = new Uint8Array(32);
  crypto.getRandomValues(array);
  return btoa(String.fromCharCode.apply(null, array))
    .replace(/\+/g, '-')
    .replace(/\//g, '_')
    .replace(/=/g, '');
}

// Code Challengeç”Ÿæˆ
async function generateCodeChallenge(verifier) {
  const encoder = new TextEncoder();
  const data = encoder.encode(verifier);
  const digest = await crypto.subtle.digest('SHA-256', data);
  return btoa(String.fromCharCode.apply(null, new Uint8Array(digest)))
    .replace(/\+/g, '-')
    .replace(/\//g, '_')
    .replace(/=/g, '');
}

// ä½¿ç”¨ä¾‹
const codeVerifier = generateCodeVerifier();
const codeChallenge = await generateCodeChallenge(codeVerifier);

console.log('Code Verifier:', codeVerifier);
console.log('Code Challenge:', codeChallenge);

// ã“ã®ä¾‹ã§ç”Ÿæˆã•ã‚Œã‚‹å€¤:
// Code Verifier: dBjftJeZ4CVP-mB92K27uhbUJU1p1r_wW1gFWFOEjXk
// Code Challenge: E9Melhoa2OwvFrEMTJguCHaoeK1t8URWbuGJSstw-cM
```

```python Python
import base64
import hashlib
import secrets

def generate_code_verifier():
    """Code Verifierç”Ÿæˆ"""
    return base64.urlsafe_b64encode(secrets.token_bytes(32)).decode('utf-8').rstrip('=')

def generate_code_challenge(verifier):
    """Code Challengeç”Ÿæˆ"""
    digest = hashlib.sha256(verifier.encode('utf-8')).digest()
    return base64.urlsafe_b64encode(digest).decode('utf-8').rstrip('=')

# ä½¿ç”¨ä¾‹
code_verifier = generate_code_verifier()
code_challenge = generate_code_challenge(code_verifier)

print(f"Code Verifier: {code_verifier}")
print(f"Code Challenge: {code_challenge}")
```

</Accordion>

---

## å®Œå…¨å®Ÿè£…ä¾‹
<CodeGroup>
```typescript TypeScript
import React, { useState, useEffect } from 'react';

interface UserInfo {
  sub: string;
  email?: string;
  email_verified?: boolean;
  name?: string;
  preferred_username?: string;
}

interface TokenResponse {
  access_token: string;
  token_type: string;
  expires_in: number;
  refresh_token?: string;
  scope: string;
  id_token?: string;
}

interface PKCEKeys {
  codeVerifier: string;
  codeChallenge: string;
}

const PLAYTUNEOAuthDemo: React.FC = () => {
  const [user, setUser] = useState<UserInfo | null>(null);
  const [tokens, setTokens] = useState<TokenResponse | null>(null);
  const [isLoading, setIsLoading] = useState<boolean>(false);
  const [error, setError] = useState<string | null>(null);

  const CLIENT_ID = 'demo_client_12345';
  const CLIENT_SECRET = 'demo_secret_abcdef';
  const REDIRECT_URI = `${window.location.origin}/callback`;
  const BASE_URL = 'https://account.playtune.jp/v1/api';

  // PKCEç”Ÿæˆ
  const generatePKCE = async (): Promise<PKCEKeys> => {
    const array = new Uint8Array(32);
    crypto.getRandomValues(array);
    const codeVerifier = btoa(String.fromCharCode.apply(null, Array.from(array)))
      .replace(/\+/g, '-')
      .replace(/\//g, '_')
      .replace(/=/g, '');
    
    const encoder = new TextEncoder();
    const data = encoder.encode(codeVerifier);
    const digest = await crypto.subtle.digest('SHA-256', data);
    const codeChallenge = btoa(String.fromCharCode.apply(null, Array.from(new Uint8Array(digest))))
      .replace(/\+/g, '-')
      .replace(/\//g, '_')
      .replace(/=/g, '');
    
    return { codeVerifier, codeChallenge };
  };

  // ãƒ©ãƒ³ãƒ€ãƒ æ–‡å­—åˆ—ç”Ÿæˆ
  const generateRandomString = (length: number = 32): string => {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let result = '';
    for (let i = 0; i < length; i++) {
      result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
  };

  // ãƒ­ã‚°ã‚¤ãƒ³é–‹å§‹
  const handleLogin = async (): Promise<void> => {
    setIsLoading(true);
    setError(null);
    
    try {
      const { codeVerifier, codeChallenge } = await generatePKCE();
      const state = generateRandomString(32);
      
      // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜
      sessionStorage.setItem('code_verifier', codeVerifier);
      sessionStorage.setItem('oauth_state', state);
      
      const authUrl = new URL(`${BASE_URL}/oauth/authorize`);
      authUrl.searchParams.set('response_type', 'code');
      authUrl.searchParams.set('client_id', CLIENT_ID);
      authUrl.searchParams.set('redirect_uri', REDIRECT_URI);
      authUrl.searchParams.set('scope', 'openid profile email');
      authUrl.searchParams.set('state', state);
      authUrl.searchParams.set('code_challenge', codeChallenge);
      authUrl.searchParams.set('code_challenge_method', 'S256');
      
      window.location.href = authUrl.toString();
    } catch (error) {
      console.error('Login failed:', error);
      setError('ãƒ­ã‚°ã‚¤ãƒ³ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
      setIsLoading(false);
    }
  };

  // ãƒˆãƒ¼ã‚¯ãƒ³äº¤æ›
  const exchangeTokens = async (code: string, codeVerifier: string): Promise<TokenResponse> => {
    const response = await fetch(`${BASE_URL}/oauth/token`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'Authorization': 'Basic ' + btoa(`${CLIENT_ID}:${CLIENT_SECRET}`)
      },
      body: new URLSearchParams({
        grant_type: 'authorization_code',
        code: code,
        redirect_uri: REDIRECT_URI,
        code_verifier: codeVerifier
      })
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(`Token exchange failed: ${errorData.error_description || errorData.error}`);
    }
    
    return await response.json();
  };

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
  const fetchUserInfo = async (accessToken: string): Promise<UserInfo> => {
    const response = await fetch(`${BASE_URL}/oauth/userinfo`, {
      headers: {
        'Authorization': `Bearer ${accessToken}`
      }
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(`User info fetch failed: ${errorData.error_description || errorData.error}`);
    }
    
    return await response.json();
  };

  // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
  useEffect(() => {
    const handleCallback = async (): Promise<void> => {
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      const state = urlParams.get('state');
      const error = urlParams.get('error');
      
      if (error) {
        setError(`èªè¨¼ã‚¨ãƒ©ãƒ¼: ${error}`);
        setIsLoading(false);
        return;
      }
      
      if (code && state) {
        try {
          const expectedState = sessionStorage.getItem('oauth_state');
          if (state !== expectedState) {
            throw new Error('Invalid state parameter - potential CSRF attack');
          }
          
          const codeVerifier = sessionStorage.getItem('code_verifier');
          if (!codeVerifier) {
            throw new Error('Code verifier not found');
          }
          
          const tokenData = await exchangeTokens(code, codeVerifier);
          setTokens(tokenData);
          
          if (tokenData.access_token) {
            const userData = await fetchUserInfo(tokenData.access_token);
            setUser(userData);
          }
          
          // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
          sessionStorage.removeItem('oauth_state');
          sessionStorage.removeItem('code_verifier');
          window.history.replaceState({}, document.title, window.location.pathname);
          
        } catch (error) {
          console.error('Callback handling failed:', error);
          setError(error instanceof Error ? error.message : 'ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        
        setIsLoading(false);
      }
    };
    
    handleCallback();
  }, []);

  // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
  const handleLogout = async (): Promise<void> => {
    if (tokens?.refresh_token) {
      // ãƒˆãƒ¼ã‚¯ãƒ³å¤±åŠ¹
      try {
        await fetch(`${BASE_URL}/oauth/revoke`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Authorization': 'Basic ' + btoa(`${CLIENT_ID}:${CLIENT_SECRET}`)
          },
          body: new URLSearchParams({
            token: tokens.refresh_token,
            token_type_hint: 'refresh_token'
          })
        });
      } catch (error) {
        console.error('Token revocation failed:', error);
      }
    }
    
    setUser(null);
    setTokens(null);
    setError(null);
  };

  if (isLoading) {
    return (
      <div style={{ textAlign: 'center', padding: '20px' }}>
        <div>èªè¨¼ä¸­...</div>
      </div>
    );
  }

  if (error) {
    return (
      <div style={{ textAlign: 'center', padding: '20px', color: 'red' }}>
        <h3>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h3>
        <p>{error}</p>
        <button onClick={() => setError(null)}>å†è©¦è¡Œ</button>
      </div>
    );
  }

  return (
    <div style={{ maxWidth: '600px', margin: '0 auto', padding: '20px' }}>
      {user ? (
        <div>
          <h2>âœ… èªè¨¼æˆåŠŸï¼</h2>
          <div style={{ marginBottom: '20px' }}>
            <h3>ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±:</h3>
            <table style={{ width: '100%', borderCollapse: 'collapse' }}>
              <tbody>
                <tr>
                  <td style={{ border: '1px solid #ddd', padding: '8px', fontWeight: 'bold' }}>åå‰</td>
                  <td style={{ border: '1px solid #ddd', padding: '8px' }}>{user.name || 'N/A'}</td>
                </tr>
                <tr>
                  <td style={{ border: '1px solid #ddd', padding: '8px', fontWeight: 'bold' }}>ãƒ¡ãƒ¼ãƒ«</td>
                  <td style={{ border: '1px solid #ddd', padding: '8px' }}>{user.email || 'N/A'}</td>
                </tr>
                <tr>
                  <td style={{ border: '1px solid #ddd', padding: '8px', fontWeight: 'bold' }}>ID</td>
                  <td style={{ border: '1px solid #ddd', padding: '8px' }}>{user.sub}</td>
                </tr>
                <tr>
                  <td style={{ border: '1px solid #ddd', padding: '8px', fontWeight: 'bold' }}>ãƒ¡ãƒ¼ãƒ«èªè¨¼</td>
                  <td style={{ border: '1px solid #ddd', padding: '8px' }}>
                    {user.email_verified ? 'âœ… æ¸ˆã¿' : 'âŒ æœªå®Œäº†'}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          
          {tokens && (
            <div style={{ marginBottom: '20px' }}>
              <h3>ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±:</h3>
              <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                <tbody>
                  <tr>
                    <td style={{ border: '1px solid #ddd', padding: '8px', fontWeight: 'bold' }}>ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³</td>
                    <td style={{ border: '1px solid #ddd', padding: '8px', wordBreak: 'break-all' }}>
                      {tokens.access_token.substring(0, 50)}...
                    </td>
                  </tr>
                  <tr>
                    <td style={{ border: '1px solid #ddd', padding: '8px', fontWeight: 'bold' }}>æœ‰åŠ¹æœŸé™</td>
                    <td style={{ border: '1px solid #ddd', padding: '8px' }}>{tokens.expires_in}ç§’</td>
                  </tr>
                  <tr>
                    <td style={{ border: '1px solid #ddd', padding: '8px', fontWeight: 'bold' }}>ã‚¹ã‚³ãƒ¼ãƒ—</td>
                    <td style={{ border: '1px solid #ddd', padding: '8px' }}>{tokens.scope}</td>
                  </tr>
                  <tr>
                    <td style={{ border: '1px solid #ddd', padding: '8px', fontWeight: 'bold' }}>ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³</td>
                    <td style={{ border: '1px solid #ddd', padding: '8px' }}>
                      {tokens.refresh_token ? 'âœ… ã‚ã‚Š' : 'âŒ ãªã—'}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          )}
          
          <button 
            onClick={handleLogout}
            style={{
              backgroundColor: '#dc3545',
              color: 'white',
              border: 'none',
              padding: '12px 24px',
              borderRadius: '4px',
              cursor: 'pointer',
              fontSize: '16px'
            }}
          >
            ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
          </button>
        </div>
      ) : (
        <div style={{ textAlign: 'center' }}>
          <h2>ğŸµ PLAYTUNE OAuth ãƒ‡ãƒ¢</h2>
          <p>PLAYTUNEã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>
          <button 
            onClick={handleLogin}
            style={{
              backgroundColor: '#007bff',
              color: 'white',
              border: 'none',
              padding: '12px 24px',
              borderRadius: '4px',
              cursor: 'pointer',
              fontSize: '16px'
            }}
          >
            ğŸš€ PLAYTUNEã§ãƒ­ã‚°ã‚¤ãƒ³
          </button>
        </div>
      )}
    </div>
  );
};

export default PLAYTUNEOAuthDemo;
```
```python Python
import os
import secrets
import hashlib
import base64
import urllib.parse
import requests
from flask import Flask, session, redirect, url_for, request, render_template_string

app = Flask(__name__)
app.secret_key = os.environ.get('FLASK_SECRET_KEY', 'your-secret-key-change-in-production')

# è¨­å®š
CLIENT_ID = 'demo_client_12345'
CLIENT_SECRET = 'demo_secret_abcdef'
REDIRECT_URI = 'http://localhost:5000/callback'
SCOPES = 'openid profile email'
BASE_URL = 'https://account.playtune.jp/v1/api'

class OAuthError(Exception):
    """OAuthé–¢é€£ã®ã‚¨ãƒ©ãƒ¼"""
    pass

def generate_pkce():
    """PKCEç”¨ã®ã‚³ãƒ¼ãƒ‰ãƒ™ãƒªãƒ•ã‚¡ã‚¤ã‚¢ã¨ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’ç”Ÿæˆ"""
    code_verifier = base64.urlsafe_b64encode(secrets.token_bytes(96)).decode('utf-8').rstrip('=')
    code_challenge = base64.urlsafe_b64encode(
        hashlib.sha256(code_verifier.encode('utf-8')).digest()
    ).decode('utf-8').rstrip('=')
    return code_verifier, code_challenge

def exchange_code_for_tokens(code, code_verifier):
    """èªå¯ã‚³ãƒ¼ãƒ‰ã‚’ãƒˆãƒ¼ã‚¯ãƒ³ã¨äº¤æ›"""
    credentials = base64.b64encode(f"{CLIENT_ID}:{CLIENT_SECRET}".encode()).decode()
    
    headers = {
        'Content-Type': 'application/x-www-form-urlencoded',
        'Authorization': f'Basic {credentials}'
    }
    
    data = {
        'grant_type': 'authorization_code',
        'code': code,
        'redirect_uri': REDIRECT_URI,
        'code_verifier': code_verifier
    }
    
    try:
        response = requests.post(
            f'{BASE_URL}/oauth/token',
            headers=headers,
            data=data,
            timeout=10
        )
        response.raise_for_status()
        return response.json()
    except requests.RequestException as e:
        raise OAuthError(f"ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼: {str(e)}")

def get_user_info(access_token):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—"""
    headers = {
        'Authorization': f'Bearer {access_token}'
    }
    
    try:
        response = requests.get(
            f'{BASE_URL}/oauth/userinfo',
            headers=headers,
            timeout=10
        )
        response.raise_for_status()
        return response.json()
    except requests.RequestException as e:
        raise OAuthError(f"ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼: {str(e)}")

def revoke_token(token):
    """ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å¤±åŠ¹"""
    credentials = base64.b64encode(f"{CLIENT_ID}:{CLIENT_SECRET}".encode()).decode()
    
    headers = {
        'Content-Type': 'application/x-www-form-urlencoded',
        'Authorization': f'Basic {credentials}'
    }
    
    data = {
        'token': token,
        'token_type_hint': 'refresh_token'
    }
    
    try:
        requests.post(
            f'{BASE_URL}/oauth/revoke',
            headers=headers,
            data=data,
            timeout=10
        )
    except requests.RequestException as e:
        print(f"ãƒˆãƒ¼ã‚¯ãƒ³å¤±åŠ¹ã‚¨ãƒ©ãƒ¼: {str(e)}")

@app.route('/')
def index():
    """ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸"""
    user = session.get('user')
    tokens = session.get('tokens')
    
    if user:
        return render_template_string(DASHBOARD_TEMPLATE, user=user, tokens=tokens)
    else:
        return render_template_string(LOGIN_TEMPLATE)

@app.route('/login')
def login():
    """ãƒ­ã‚°ã‚¤ãƒ³é–‹å§‹"""
    # PKCEç”Ÿæˆ
    code_verifier, code_challenge = generate_pkce()
    state = secrets.token_urlsafe(32)
    
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜
    session['code_verifier'] = code_verifier
    session['oauth_state'] = state
    
    # èªè¨¼URLã‚’æ§‹ç¯‰
    params = {
        'response_type': 'code',
        'client_id': CLIENT_ID,
        'redirect_uri': REDIRECT_URI,
        'scope': SCOPES,
        'state': state,
        'code_challenge': code_challenge,
        'code_challenge_method': 'S256'
    }
    
    auth_url = f"{BASE_URL}/oauth/authorize?{urllib.parse.urlencode(params)}"
    return redirect(auth_url)

@app.route('/callback')
def callback():
    """èªè¨¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯"""
    code = request.args.get('code')
    state = request.args.get('state')
    error = request.args.get('error')
    
    # ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
    if error:
        return render_template_string(ERROR_TEMPLATE, error=f"èªè¨¼ã‚¨ãƒ©ãƒ¼: {error}")
    
    if not code or not state:
        return render_template_string(ERROR_TEMPLATE, error="èªè¨¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™")
    
    # Stateæ¤œè¨¼
    if state != session.get('oauth_state'):
        return render_template_string(ERROR_TEMPLATE, error="Stateä¸ä¸€è‡´ã‚¨ãƒ©ãƒ¼")
    
    try:
        # ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
        code_verifier = session.get('code_verifier')
        tokens = exchange_code_for_tokens(code, code_verifier)
        
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
        user_info = get_user_info(tokens['access_token'])
        
        # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜
        session['tokens'] = tokens
        session['user'] = user_info
        
        # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        session.pop('code_verifier', None)
        session.pop('oauth_state', None)
        
        return redirect(url_for('index'))
        
    except OAuthError as e:
        return render_template_string(ERROR_TEMPLATE, error=str(e))

@app.route('/logout')
def logout():
    """ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ"""
    tokens = session.get('tokens')
    
    # ãƒˆãƒ¼ã‚¯ãƒ³å¤±åŠ¹
    if tokens and tokens.get('refresh_token'):
        revoke_token(tokens['refresh_token'])
    
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒªã‚¢
    session.clear()
    
    return redirect(url_for('index'))

@app.route('/refresh')
def refresh_token():
    """ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥"""
    tokens = session.get('tokens')
    if not tokens or not tokens.get('refresh_token'):
        return redirect(url_for('login'))
    
    credentials = base64.b64encode(f"{CLIENT_ID}:{CLIENT_SECRET}".encode()).decode()
    
    headers = {
        'Content-Type': 'application/x-www-form-urlencoded',
        'Authorization': f'Basic {credentials}'
    }
    
    data = {
        'grant_type': 'refresh_token',
        'refresh_token': tokens['refresh_token']
    }
    
    try:
        response = requests.post(
            f'{BASE_URL}/oauth/token',
            headers=headers,
            data=data,
            timeout=10
        )
        response.raise_for_status()
        new_tokens = response.json()
        session['tokens'] = new_tokens
        
        return redirect(url_for('index'))
    except requests.RequestException as e:
        return render_template_string(ERROR_TEMPLATE, error=f"ãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°ã‚¨ãƒ©ãƒ¼: {str(e)}")

# HTMLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
LOGIN_TEMPLATE = '''
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlayTune OAuth Demo</title>
    <style>
        body { font-family: system-ui, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; text-align: center; }
        .btn { background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; text-decoration: none; display: inline-block; font-size: 16px; }
        .btn:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>ğŸµ PlayTune OAuth ãƒ‡ãƒ¢</h1>
    <p>PlayTuneã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>
    <a href="/login" class="btn">ğŸš€ PlayTuneã§ãƒ­ã‚°ã‚¤ãƒ³</a>
</body>
</html>
'''

DASHBOARD_TEMPLATE = '''
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - PlayTune OAuth Demo</title>
    <style>
        body { font-family: system-ui, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
        .btn { background: #dc3545; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; text-decoration: none; display: inline-block; font-size: 16px; margin: 10px 5px; }
        .btn:hover { background: #c82333; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #545b62; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f8f9fa; font-weight: bold; }
        .token { word-break: break-all; }
    </style>
</head>
<body>
    <h1>âœ… èªè¨¼æˆåŠŸï¼</h1>
    
    <h2>ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</h2>
    <table>
        <tr><th>åå‰</th><td>{{ user.name or 'N/A' }}</td></tr>
        <tr><th>ãƒ¡ãƒ¼ãƒ«</th><td>{{ user.email or 'N/A' }}</td></tr>
        <tr><th>ID</th><td>{{ user.sub }}</td></tr>
        <tr><th>ãƒ¡ãƒ¼ãƒ«èªè¨¼</th><td>{{ 'âœ… æ¸ˆã¿' if user.email_verified else 'âŒ æœªå®Œäº†' }}</td></tr>
    </table>
    
    {% if tokens %}
    <h2>ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±</h2>
    <table>
        <tr><th>ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³</th><td class="token">{{ tokens.access_token[:50] }}...</td></tr>
        <tr><th>æœ‰åŠ¹æœŸé™</th><td>{{ tokens.expires_in }}ç§’</td></tr>
        <tr><th>ã‚¹ã‚³ãƒ¼ãƒ—</th><td>{{ tokens.scope }}</td></tr>
        <tr><th>ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³</th><td>{{ 'âœ… ã‚ã‚Š' if tokens.refresh_token else 'âŒ ãªã—' }}</td></tr>
    </table>
    {% endif %}
    
    <div>
        <a href="/refresh" class="btn btn-secondary">ğŸ”„ ãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°</a>
        <a href="/logout" class="btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
    </div>
</body>
</html>
'''

ERROR_TEMPLATE = '''
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¨ãƒ©ãƒ¼ - PlayTune OAuth Demo</title>
    <style>
        body { font-family: system-ui, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; text-align: center; }
        .error { color: #dc3545; background: #f8d7da; border: 1px solid #f5c6cb; padding: 20px; border-radius: 4px; margin: 20px 0; }
        .btn { background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; text-decoration: none; display: inline-block; font-size: 16px; }
    </style>
</head>
<body>
    <h1>âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h1>
    <div class="error">{{ error }}</div>
    <a href="/" class="btn">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>
</body>
</html>
'''

if __name__ == '__main__':
    app.run(debug=True, host='localhost', port=5000)
```

</CodeGroup>

---